{"file":"src/ui/components/QueueBattleView.tsx","search":"  const [playbackLock, setPlaybackLock] = useState(false);\n  const playbackTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const loadedFxRef = useRef<Set<string>>(new Set());\n\n  // Reset per-battle transient state\n","replace":"  const [playbackLock, setPlaybackLock] = useState(false);\n  const playbackTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const loadedFxRef = useRef<Set<string>>(new Set());\n  const [floatingNumbers, setFloatingNumbers] = useState<\n    { id: number; unitId: string; amount: number; kind: 'damage' | 'heal' }[]\n  >([]);\n  const floatingIdRef = useRef(0);\n  const floatingTimeoutsRef = useRef<Map<number, ReturnType<typeof setTimeout>>>(new Map());\n  const lastProcessedEventRef = useRef<BattleEvent | undefined>(undefined);\n\n  // Reset per-battle transient state\n"}
{"file":"src/ui/components/QueueBattleView.tsx","search":"  const currentFx = useMemo(() => resolveFxForEvent(events[0]), [events]);\n\n  // 4. Event Queue Processing\n  useEffect(() => {\n    // Clear playback state when leaving execution or no events\n","replace":"  const currentFx = useMemo(() => resolveFxForEvent(events[0]), [events]);\n\n  // Reset floating numbers when battle changes and clear timers on unmount\n  useEffect(() => {\n    floatingTimeoutsRef.current.forEach((timeout) => clearTimeout(timeout));\n    floatingTimeoutsRef.current.clear();\n    setFloatingNumbers([]);\n    lastProcessedEventRef.current = undefined;\n\n    return () => {\n      floatingTimeoutsRef.current.forEach((timeout) => clearTimeout(timeout));\n      floatingTimeoutsRef.current.clear();\n    };\n  }, [battle]);\n\n  // Spawn floating damage/heal numbers when events resolve\n  useEffect(() => {\n    if (!battle || battle.phase !== 'executing') return;\n    const evt = events[0];\n    if (!evt) return;\n    if (evt === lastProcessedEventRef.current) return;\n    lastProcessedEventRef.current = evt;\n\n    if (evt.type === 'hit' || evt.type === 'heal') {\n      const id = floatingIdRef.current + 1;\n      floatingIdRef.current = id;\n      const kind = evt.type === 'heal' ? 'heal' : 'damage';\n      setFloatingNumbers((prev) => [...prev, { id, unitId: evt.targetId, amount: evt.amount, kind }]);\n      const timeoutId = setTimeout(() => {\n        setFloatingNumbers((prev) => prev.filter((n) => n.id !== id));\n        floatingTimeoutsRef.current.delete(id);\n      }, 1150);\n      floatingTimeoutsRef.current.set(id, timeoutId);\n    }\n  }, [battle?.phase, events]);\n\n  // 4. Event Queue Processing\n  useEffect(() => {\n    // Clear playback state when leaving execution or no events\n"}
{"file":"src/ui/components/QueueBattleView.tsx","search":"      >\n        {/* Battlefield Area */}\n        <div\n          style={{\n","replace":"      >\n        <style>\n          {`\n            @keyframes floatNumber {\n              0% { opacity: 1; transform: translate(-50%, 0) scale(1); }\n              60% { opacity: 1; transform: translate(-50%, -6px) scale(1.02); }\n              100% { opacity: 0; transform: translate(-50%, -24px) scale(1.05); }\n            }\n          `}\n        </style>\n        {/* Battlefield Area */}\n        <div\n          style={{\n"}
{"file":"src/ui/components/QueueBattleView.tsx","search":"                  >\n                    <SimpleSprite\n                      id={spriteId}\n                      width={64}\n                      height={64}\n                      fallback={\n                        <SimpleSprite\n                          id=\"/sprites/battle/enemies/Goblin.gif\"\n                          width={64}\n                          height={64}\n                          imageRendering=\"pixelated\"\n                        />\n                      }\n                      imageRendering=\"pixelated\"\n                    />\n                  </div>\n                  <div\n                    style={{\n                      marginTop: 4,\n                      fontSize: '0.8rem',\n                      color: isTargetCandidate ? '#FFD87F' : '#aaa',\n                    }}\n","replace":"                  >\n                    <SimpleSprite\n                      id={spriteId}\n                      width={64}\n                      height={64}\n                      fallback={\n                        <SimpleSprite\n                          id=\"/sprites/battle/enemies/Goblin.gif\"\n                          width={64}\n                          height={64}\n                          imageRendering=\"pixelated\"\n                        />\n                      }\n                      imageRendering=\"pixelated\"\n                    />\n                  </div>\n                  {floatingNumbers\n                    .filter((n) => n.unitId === enemy.id)\n                    .map((num, idx) => {\n                      const displayValue = Math.abs(num.amount);\n                      return (\n                        <div\n                          key={num.id}\n                          style={{\n                            position: 'absolute',\n                            bottom: `calc(100% + ${idx * 16 + 6}px)`,\n                            left: '50%',\n                            color: num.kind === 'heal' ? '#6df0a2' : '#ff6b6b',\n                            fontWeight: 800,\n                            textShadow: '0 0 6px rgba(0,0,0,0.8)',\n                            animation: 'floatNumber 1.05s ease-out forwards',\n                            pointerEvents: 'none',\n                            zIndex: 12,\n                          }}\n                        >\n                          {num.kind === 'heal' ? `+${displayValue}` : `-${displayValue}`}\n                        </div>\n                      );\n                    })}\n                  <div\n                    style={{\n                      marginTop: 4,\n                      fontSize: '0.8rem',\n                      color: isTargetCandidate ? '#FFD87F' : '#aaa',\n                    }}\n"}
{"file":"src/ui/components/QueueBattleView.tsx","search":"                  >\n                    <BattleUnitSprite unitId={unit.id} state=\"idle\" size=\"large\" />\n                  </div>\n                </div>\n              );\n            })}\n","replace":"                  >\n                    <BattleUnitSprite unitId={unit.id} state=\"idle\" size=\"large\" />\n                  </div>\n                  {floatingNumbers\n                    .filter((n) => n.unitId === unit.id)\n                    .map((num, idx) => {\n                      const displayValue = Math.abs(num.amount);\n                      return (\n                        <div\n                          key={num.id}\n                          style={{\n                            position: 'absolute',\n                            bottom: `calc(100% + ${idx * 16 + 6}px)`,\n                            left: '50%',\n                            color: num.kind === 'heal' ? '#6df0a2' : '#ff6b6b',\n                            fontWeight: 800,\n                            textShadow: '0 0 6px rgba(0,0,0,0.8)',\n                            animation: 'floatNumber 1.05s ease-out forwards',\n                            pointerEvents: 'none',\n                            zIndex: 12,\n                          }}\n                        >\n                          {num.kind === 'heal' ? `+${displayValue}` : `-${displayValue}`}\n                        </div>\n                      );\n                    })}\n                </div>\n              );\n            })}\n"}
